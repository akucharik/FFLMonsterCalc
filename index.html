<!DOCTYPE html>
<html lang="en">
<head>
	<title>Final Fantasy Legend Monster Transformation Calculator</title>
    <!--<link href='src/styles/bootstrap.min.css' rel='stylesheet' type='text/css'>-->
    <style>
        /* Fonts */
        @font-face {
            font-family: 'GraphicPixel';
            src: url('fonts/graphicpixel-webfont.eot');
            src: url('fonts/graphicpixel-webfont.eot?#iefix') format('embedded-opentype'),
                 url('fonts/graphicpixel-webfont.woff') format('woff'),
                 url('fonts/graphicpixel-webfont.ttf') format('truetype'),
                 url('fonts/graphicpixel-webfont.svg#GraphicPixelRegular') format('svg');
            font-weight: normal;
            font-style: normal;
        }

        body, button, input, select {
            font-family: 'GraphicPixel', sans-serif;
            font-size: 20px;
            /*font-smooth: never;
            -webkit-font-smoothing: none;*/
        }
        
        h2 {
            
        }
        
        /* Forms */
        .ffl-dropdown-label {
            font-size: 80%;
        }
        
        .ffl-dropdown-list {
            box-sizing: border-box;
            font-size: 200%;
            position: relative;
            text-transform: uppercase;
            top: -0.1em;
            width: 100%;
        }
        
        /* Box */
        .ffl-box {
            box-sizing: border-box;
            height: 100%;
            padding: 0.8em 0.7em 0.5em 0.7em;
            position: relative;
        }
        
        .ffl-box::before {
            border: 2px solid #aaa;
            border-right-color: #666;
            border-bottom-color: #666;
            border-radius: 9px;
            content: '';
            display: block;
            position: absolute;
            top: -2px;
            right: -2px;
            bottom: -2px;
            left: -2px;
        }
        
        .ffl-box::after {
            border: 2px solid #666;
            border-right-color: #aaa;
            border-bottom-color: #aaa;
            border-radius: 6px;
            content: '';
            display: block;
            position: absolute;
            top: 2px;
            right: 2px;
            bottom: 2px;
            left: 2px;
        }
        
        .ffl-box-edge {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
        }
        
        .ffl-box-edge::before {
            border: 2px solid #000;
            border-radius: 11px;
            box-sizing: border-box;
            content: '';
            display: block;
            position: absolute;
            top: -4px;
            right: -4px;
            bottom: -4px;
            left: -4px;
        }
        
        .ffl-box-edge::after {
            border: 2px solid #000;
            border-right-color: #666;
            border-bottom-color: #666;
            border-radius: 4px;
            box-sizing: border-box;
            content: '';
            display: block;
            position: absolute;
            top: 4px;
            right: 4px;
            bottom: 4px;
            left: 4px;
        }
        
        .ffl-box-content {
        
        }
        
        /* Monster Calculator Layout */
        .ffl-monster-calc-layout {
            align-items: flex-start;
            display: flex;
        }
        
        .ffl-monster-separator {
            font-size: 300%;
            margin-top: 13rem;
        }
        
        /* Monster */
        .ffl-monster {
            margin: 0 1.0em;
            width: 220px;
        }
        
        .ffl-monster-top > h2 {
            font-size: 120%;
            margin: 0;
        }
        
        .ffl-monster-image-mask {
            margin: 0.5rem auto;
            overflow: hidden;
            position: relative;
        }
        
        .ffl-monster-image-mask > img {
            position: absolute;
        }
        
        .ffl-monster-avatar-mask {
            margin: 0.5rem auto 0.8rem auto;
            overflow: hidden;
            position: relative;
        }
        
        .ffl-avatar-walk-vertical {
            animation: ffl-avatar-walk-vertical 0.8s infinite;
        }
        
        @keyframes ffl-avatar-walk-vertical {
            49.999% {
                transform: scaleX(1);
            }
            50% {
                transform: scaleX(-1);
            }
            99.999% {
                transform: scaleX(-1);
            }
            100% {
                transform: scaleX(1);
            }
        }
        
        .ffl-monster-avatar-mask > img {
            left: -200px;
            position: absolute;
            top: -632px;
        }
        
        /* Abilities & Skills */
        .ffl-monster-layout {
            display: flex;
        }
        
        .ffl-monster-abilities-col {
            width: 3.4rem;
        }
                
        .ffl-monster-skills-col {
            flex: 1;
            margin-left: 1.0em !important;
        }
        
        .ffl-abilities {
            letter-spacing: 2px;
        }
        
        .ffl-abilities > li,
        .ffl-skills > li
        {
            margin-top: 0.5rem;
        }
        
        .ffl-abilities > li > label,
        .ffl-abilities > li > span,
        .ffl-skills > li > label,
        .ffl-skills > li > span {
            line-height: 1;
        }
        
        .ffl-abilities > li > span {
            display: block;
            margin-top: -0.2rem;
            text-align: right;
        }
        
        .ffl-skills {
            text-transform: uppercase;
        }
        
        .ffl-skills > li {
            display: flex;
        }
        
        .ffl-skills > li > label {
            flex: 1;
        }
        
    </style>
</head>
<body>
    <!--<div style="border: 1px solid red; height: 192px; width: 192px; position: relative;">
        <img src="images/FFL-Spritesheet-White-1827x1215.png" width="1827" height="1215" style="left: -3px; top: -618px; position: absolute;" />
        <div style="border: 1px solid green; height: 192px; width: 96px; left: -1px; top: 193px; position: absolute;"></div>
        <div style="border: 1px solid blue; height: 192px; width: 96px; left: -1px; top: 422px; position: absolute;"></div>
    </div>-->
    <h1>Final Fantasy Legend<br/>Monster Tranformation Calculator</h1>
    <div class="ffl-monster-calc-layout">
        <div class="ffl-monster">
            <div id="startingMonsterTop" class="ffl-monster-top">
                <h2>Start</h2>
                <label class="ffl-dropdown-label" for="ddlStartingMonsterType">Monster Type</label>
                <select id="ddlStartingMonsterType" class="ffl-dropdown-list"></select>
                <label class="ffl-dropdown-label" for="ddlStartingMonster">Monster</label>
                <select id="ddlStartingMonster" class="ffl-dropdown-list"></select>
            </div>
            <div id="startingMonster"></div>
        </div>
        <div class="ffl-monster-separator">+</div>
        <div class="ffl-monster">
            <div id="meatOfMonsterTop" class="ffl-monster-top">
                <h2>Meat</h2>
                <label class="ffl-dropdown-label" for="ddlMeatOfMonsterType">Monster Type</label>
                <select id="ddlMeatOfMonsterType" class="ffl-dropdown-list"></select>
                <label class="ffl-dropdown-label" for="ddlMeatOfMonster">Monster</label>
                <select id="ddlMeatOfMonster" class="ffl-dropdown-list"></select>
            </div>
            <div id="meatOfMonster"></div>
        </div>
        <div class="ffl-monster-separator">=</div>
        <div class="ffl-monster">
            <div id="newMonsterMessage" class="ffl-monster-top"></div>
            <div id="newMonster"></div>
        </div>
    </div>
    
    <script id="messageTemplate" type="text/template">        
        <div class="ffl-box">
            <div class="ffl-box-edge"></div>
            <div class="ffl-box-content message"></div>
        </div>
    </script>
    
    <script id="monsterTemplate" type="text/template">
        <div class="imageMask ffl-monster-image-mask" style="height: <%= item.image.height %>px; width: <%= item.image.width %>px;">
            <img src="images/FFL-Spritesheet-White-1827x1215.png" class="image" alt="Starting monster image" width="1827" height="1215" style="left: <%= item.image.x %>px; top: <%= item.image.y %>px;" />
        </div>
        
        <div class="ffl-box">
            <div class="ffl-box-edge"></div>
            <div class="ffl-box-content ffl-monster-layout">
                <div class="ffl-monster-abilities-col">
                    <div class="avatarMask ffl-monster-avatar-mask ffl-avatar-walk">
                        <img src="images/FFL-Spritesheet-White-1218x810.png" class="avatar" alt="Starting monster avatar portrait" width="1218" height="810" />
                    </div>
                    <ul id="startingMonsterAbilities" class="ffl-abilities" style="list-style-type: none; margin: 0; padding: 0;">
                        <li>
                            <label>Str.</label>
                            <span class="strength"><%= item.strength %></span>
                        </li>
                        <li>
                            <label>Def.</label>
                            <span class="defense"><%= item.defense %></span>
                        </li>
                        <li>
                            <label>Agl.</label>
                            <span class="agility"><%= item.agility %></span>
                        </li>
                        <li>
                            <label>Mana</label>
                            <span class="mana"><%= item.mana %></span>
                        </li>
                    </ul>
                </div>

                <div class="ffl-monster-skills-col">
                    <ul id="startingMonsterHp" class="ffl-skills" style="list-style-type: none; margin: 0; margin-bottom: 1.4em; padding: 0;">
                        <li>
                            <label>HP</label>
                            <span class="hp"><%= item.hp %></span>
                        </li>
                    </ul>
                    <ul class="ffl-skills" style="list-style-type: none; margin: 0; padding: 0;">
                        <li>
                            <label>Beak</label>
                            <span>25</span>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </script>

    <script id="monsterImageTemplate" type="text/template">
        <div class="ffl-monster-image-mask" style="height: <%= item.image.height %>px; width: <%= item.image.width %>px;">
            <img src="images/FFL-Spritesheet-White-1827x1215.png" alt="Starting monster image" width="1827" height="1215" style="left: <%= item.image.x %>px; top: <%= item.image.y %>px;" />
        </div>
    </script>
    
    <script id="monsterAbilitiesTemplate" type="text/template">
        <li>
            <label>Str.</label>
            <span><%= item.strength %></span>
        </li>
        <li>
            <label>Def.</label>
            <span><%= item.defense %></span>
        </li>
        <li>
            <label>Agl.</label>
            <span><%= item.agility %></span>
        </li>
        <li>
            <label>Mana</label>
            <span><%= item.mana %></span>
        </li>
    </script>
    
    <script id="monsterHpTemplate" type="text/template">
        <li>
            <label>HP</label>
            <span><%= item.hp %></span>
        </li>
    </script>
    
    <script type="text/javascript" src="src/scripts/jquery-2.1.4.min.js"></script>
    <script type="text/javascript" src="src/scripts/underscore-min.js"></script>
    <script type="text/javascript" src="src/scripts/backbone-min.js"></script>
    <script type="text/javascript" src="src/scripts/constants.js"></script>
    <script type="text/javascript" src="src/scripts/calculatorModel.js"></script>
    <script>
        
        // Dropdown List
        var bbDropdownList = function (options) {
            var instance = Object.create(Backbone.View.prototype);
            
            Object.assign(instance, options);
            
            instance.initialize = function () {
                instance.items = [];
                instance.itemValueIsKeyed = instance.itemValueKey ? true : false;
                
                instance.delegateEvents();
                instance.listenTo(instance.model, ('change:' + instance.itemsKey), instance.render);
                instance.listenTo(instance.model, ('change:' + instance.selectedValueKey), instance.selectItem);
                instance.render();
            };
            
            instance.events = {
                'change': 'onChange'
            };
            
            instance.onChange = function () {
                instance.model.set(instance.selectedValueKey, instance.$(instance.items).filter(':selected').data('value'));
            };
            
            instance.render = function () {
                var placeholder = document.createDocumentFragment();
                
                instance.items = [];
                
                _.each(instance.model.get(instance.itemsKey), function (item) {
                    var option = document.createElement('option');
                    
                    option.text = item[instance.itemTextKey];
                    $(option).data('value', (instance.itemValueIsKeyed ? item[instance.itemValueKey] : item));
                    
                    instance.items.push(option);
                    placeholder.appendChild(option);
                });
                
                instance.$el.html(placeholder);
                
                if (instance.model.get(instance.itemsKey).length > 0) {
                    instance.selectItem();
                }
            };
            
            instance.getSelectedItem = function () {
                var selectedItem = null;
                
                if (_.isObject(instance.model.get(instance.selectedValueKey))) {
                    selectedItem = _.find(instance.items, function (item) {
                        return _.isEqual($(item).data('value'), instance.model.get(instance.selectedValueKey));
                    });
                }
                else {
                    selectedItem = _.find(instance.items, function (item) {
                        return $(item).data('value') === instance.model.get(instance.selectedValueKey);
                    });
                }

                return _.isUndefined(selectedItem) ? null : selectedItem;
            };
            
            instance.selectItem = function () {
                var selectedItem = instance.getSelectedItem();
                
                if (selectedItem) {
                    selectedItem.selected = true;
                }
                else {
                    instance.model.set(instance.selectedValueKey, instance.itemValueIsKeyed ? instance.model.get(instance.itemsKey)[0][instance.itemValueKey] : instance.model.get(instance.itemsKey)[0]);
                }
            };
            
            Backbone.View.call(instance, options);
            
            return instance;
        };
        
        // Fixed Height View Behavior
        var bbFixedHeightView = function () {
            var instance = {};
            
            instance.setHeight = function (height) {
                if (_.isNumber(height)) {
                    this.$el.height(height);
                }
                else if (_.isElement(height)) {
                    this.$el.height(height.clientHeight);
                }
                else if (_.isFunction(height)) {
                    this.$el.height(height());
                }
            };
            
            return instance;
        };
        
        // Message View
        var messageView = function (options) {
            var instance = Object.create(Object.assign(
                Backbone.View.prototype, bbFixedHeightView()
            ));
            
            Object.assign(instance, options);
            
            instance.initialize = function () {
                instance.template = _.template(instance.templateEl.innerHTML);
                
                instance.listenTo(instance.model, ('change:' + instance.itemKey), instance.update);
                window.addEventListener('load', instance.render);
            };
            
            instance.render = function () {
                instance.$el.html(instance.template());
                instance.setHeight(instance.height);
                instance.messageEl = instance.el.querySelector(instance.messageSelector);
                instance.update();
            };
            
            instance.update = function () {
                instance.printMessage(instance.model.get(instance.itemKey), instance.messageEl);
            };
            
            instance.printMessage = function (message, target) {
                var printString = function (i) {
                    target.innerHTML = message.substring(0, i).replace(/(\n)/g, '<br>');
                };

                for (var i = 1; i <= message.length; i++) {
                    window.setTimeout(printString, constants.MESSAGE.SPEED * i, i);
                }
            };
            
            Backbone.View.call(instance, options);
            
            return instance;
        };
        
        // Template View
        var bbTemplateView = function (options) {
            var instance = Object.create(Backbone.View.prototype);
            
            Object.assign(instance, options);
            
            instance.initialize = function () {
                instance.listenTo(instance.model, ('change:' + instance.itemKey), instance.render);
                
                instance.template = _.template(instance.templateEl.innerHTML, { variable: 'item' });
                instance.render();
            };
            
            instance.render = function () {
                instance.$el.html(instance.template(instance.model.get(instance.itemKey)));
            };
            
            Backbone.View.call(instance, options);
            
            return instance;
        };
        
        // TODO: Optimize view for "nothing happened" scenario
        // Monster View
        var monsterView = function (options) {
            var instance = Object.create(Backbone.View.prototype);
            
            Object.assign(instance, options);
            
            instance.initialize = function () {
                instance.listenTo(instance.model, ('change:' + instance.itemKey), instance.update);
                
                if (instance.model.get(instance.itemKey)) {
                    instance.template = _.template(instance.templateEl.innerHTML, { variable: 'item' });
                    instance.render();
                }
            };
            
            instance.render = function () {
                if (instance.model.get(instance.itemKey)) {
                    instance.$el.html(instance.template(instance.model.get(instance.itemKey)));
                }
                instance.onRender();
                instance.update();
            };
            
            instance.onRender = function () {
                instance.imageMask = instance.el.querySelector('.imageMask');
                instance.image = instance.el.querySelector('.image');
                instance.$avatarMask = instance.$('.avatarMask');
                instance.$avatar = instance.$('.avatar');
                instance.$strength = instance.$('.strength');
                instance.$defense = instance.$('.defense');
                instance.$agility = instance.$('.agility');
                instance.$mana = instance.$('.mana');
                instance.$hp = instance.$('.hp');
            };
            
            instance.update = function () {
                var monster = instance.model.get(instance.itemKey);
                
                if (monster && instance.template) {
                    instance.imageMask.setAttribute('style', 'height: ' + monster.image.height + 'px; width: ' + monster.image.width + 'px;');
                    instance.image.setAttribute('style', 'left: ' + monster.image.x + 'px; top: ' + monster.image.y + 'px;');
                    instance.$avatarMask.css({
                        height: monster.avatar.height + 'px',
                        width: monster.avatar.width + 'px'
                    });
                    instance.$avatar.css({
                        left: monster.avatar.x + 'px',
                        top: monster.avatar.y + 'px'
                    });
                    if (instance.model.get(instance.itemKey).type !== constants.MONSTER.TYPE.FIEND.KEY) {
                        instance.$avatarMask.addClass('ffl-avatar-walk-vertical');
                    }
                    else {
                        instance.$avatarMask.removeClass('ffl-avatar-walk-vertical');
                    }
                    instance.$strength.html(monster.strength);
                    instance.$defense.html(monster.defense);
                    instance.$agility.html(monster.agility);
                    instance.$mana.html(monster.mana);
                    instance.$hp.html(monster.hp);
                }
                else if (monster) {
                    instance.template = _.template(instance.templateEl.innerHTML, { variable: 'item' });
                    instance.render();
                }
                else {
                    instance.$el.empty();
                    instance.template = null;
                }
            };
            
            Backbone.View.call(instance, options);
            
            return instance;
        };
        
        // App
        var app = _.extend({}, Backbone.Events);
        
        app.initialize = function () {
            
            app.listenTo(calculatorModel, 'change:startingMonsterType', app.updateStartingMonsters);
            app.listenTo(calculatorModel, 'change:meatOfMonsterType', app.updateMeatOfMonsters);
            app.listenTo(calculatorModel, 'change:startingMonster', app.updateNewMonster);
            app.listenTo(calculatorModel, 'change:meatOfMonster', app.updateNewMonster);
            app.listenTo(calculatorModel, 'change:newMonster', app.updateNewMonsterMessage);
            
            // Views
            var ddlStartingMonsterType = bbDropdownList({
                el: document.getElementById('ddlStartingMonsterType'),
                model: calculatorModel,
                itemsKey: 'startingMonsterTypes',
                itemTextKey: 'name',
                selectedValueKey: 'startingMonsterType'
            });

            var ddlStartingMonster = bbDropdownList({
                el: document.getElementById('ddlStartingMonster'),
                model: calculatorModel,
                itemsKey: 'startingMonsters',
                itemTextKey: 'name',
                selectedValueKey: 'startingMonster'
            });

            var ddlMeatOfMonsterType = bbDropdownList({
                el: document.getElementById('ddlMeatOfMonsterType'),
                model: calculatorModel,
                itemsKey: 'meatOfMonsterTypes',
                itemTextKey: 'name',
                selectedValueKey: 'meatOfMonsterType'
            });

            var ddlMeatOfMonster = bbDropdownList({
                el: document.getElementById('ddlMeatOfMonster'),
                model: calculatorModel,
                itemsKey: 'meatOfMonsters',
                itemTextKey: 'name',
                selectedValueKey: 'meatOfMonster'
            });

            var startingMonster = monsterView({
                el: document.getElementById('startingMonster'),
                templateEl: document.getElementById('monsterTemplate'),
                model: calculatorModel,
                itemKey: 'startingMonster'
            });

            var meatOfMonster = monsterView({
                el: document.getElementById('meatOfMonster'),
                templateEl: document.getElementById('monsterTemplate'),
                model: calculatorModel,
                itemKey: 'meatOfMonster'
            });

            var newMonster = monsterView({
                el: document.getElementById('newMonster'),
                templateEl: document.getElementById('monsterTemplate'),
                model: calculatorModel,
                itemKey: 'newMonster'
            });
            
            var newMonsterMessage = messageView({
                el: document.getElementById('newMonsterMessage'),
                templateEl: document.getElementById('messageTemplate'),
                model: calculatorModel,
                itemKey: 'newMonsterMessage',
                messageSelector: '.message',
                height: document.getElementById('startingMonsterTop')
            });

//            var startingMonsterImage = bbTemplateView({
//                el: document.getElementById('startingMonsterImage'),
//                templateEl: document.getElementById('monsterImageTemplate'),
//                model: calculatorModel,
//                itemKey: 'startingMonster',
//            });
//
//            var startingMonsterAbilities = bbTemplateView({
//                el: document.getElementById('startingMonsterAbilities'),
//                templateEl: document.getElementById('monsterAbilitiesTemplate',
//                model: calculatorModel,
//                itemKey: 'startingMonster'
//            });
//
//            var startingMonsterHp = bbTemplateView({
//                el: document.getElementById('startingMonsterHp'),
//                templateEl: document.getElementById('monsterHpTemplate'),
//                model: calculatorModel,
//                itemKey: 'startingMonster'
//            });
        };
        
        app.updateStartingMonsters = function () {
            if (calculatorModel.get('startingMonsterType')) {
                var startingMonsters = _.where(calculatorModel.get('monsters'), { 
                    type: calculatorModel.get('startingMonsterType').id
                });
                calculatorModel.set('startingMonsters', startingMonsters);
            }
        };
        
        app.updateMeatOfMonsters = function () {
            if (calculatorModel.get('meatOfMonsterType')) {
                var meatOfMonsters = _.where(calculatorModel.get('monsters'), { 
                    type: calculatorModel.get('meatOfMonsterType').id
                });
                calculatorModel.set('meatOfMonsters', meatOfMonsters);
            }
        };
        
        // TODO: Add logic to get correct new monster
        app.updateNewMonster = function () {
            var startingMonster = calculatorModel.get('startingMonster');
            var meatOfMonster = calculatorModel.get('meatOfMonster');

            if (calculatorModel.get('startingMonster') && calculatorModel.get('meatOfMonster')) {
                var monsterLevel = Math.max(startingMonster.level, meatOfMonster.level);

                var startingTransformationGroup = calculatorModel.get('startingMonster').transformationGroup;
                var meatOfTransformationType = calculatorModel.get('meatOfMonster').transformationType;

                var newMonsterType = constants.MONSTER.TRANSFORMATION[startingTransformationGroup][meatOfTransformationType];

                if (newMonsterType) {
                    var newMonsterPossibilities = _.where(calculatorModel.get('monsters'), { 
                        type: newMonsterType
                    })

                    var newMonster = _.findWhere(newMonsterPossibilities, {
                        level: monsterLevel
                    });

                    if (newMonster === undefined) {
                        newMonster = _.findWhere(newMonsterPossibilities, {
                            level: (monsterLevel + 1)
                        });
                    }

                    if (newMonster === undefined) {
                        newMonster = app.getNewMonster(newMonsterPossibilities, monsterLevel - 1);
                    }

                    calculatorModel.set('newMonster', newMonster);
                }
                else {
                    calculatorModel.set('newMonster', null);
                }
            }
        };
        
        app.getNewMonster = function (monsters, level) {
            if (level === 0) {
                return null;
            }
            
            var newMonster = _.findWhere(monsters, {
                level: level
            });
            
            if (newMonster === undefined) {
                app.getNewMonster(monsters, (level - 1));
            }
            else {
                return newMonster;
            }
        };
        
        app.updateNewMonsterMessage = function (model, newValue) {
            if (newValue) {
                model.set('newMonsterMessage', constants.MESSAGE.TRANSFORMATION.CHANGED + newValue.name.toUpperCase());
            }
            else {
                model.set('newMonsterMessage', constants.MESSAGE.TRANSFORMATION.UNCHANGED);
            }
        };
        
        app.initialize();
        
        // TODO: Remove once development is complete
        window.model = calculatorModel;
        
    </script>
    
</body>
</html>